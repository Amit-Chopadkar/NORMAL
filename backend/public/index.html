<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TourGuard Admin Panel</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
      #topbar { background:#0b5ed7; color:white; padding:12px 16px; display:flex; align-items:center; justify-content:space-between }
      #map { height: calc(100vh - 96px); width:100%; }
      #login { padding:12px; display:flex; gap:8px; align-items:center }
      input { padding:8px; font-size:14px }
      button { padding:8px 12px; font-size:14px }
      #status { color:#fff; margin-left:12px }
    </style>
  </head>
  <body>
    <div id="topbar">
      <div style="display:flex;align-items:center">
        <strong>TourGuard ‚Äî Admin</strong>
        <span id="status"></span>
      </div>
      <div id="login">
        <input id="email" type="email" placeholder="admin email" />
        <input id="password" type="password" placeholder="password" />
        <button id="btnLogin">Login</button>
        <button id="btnLogout" style="display:none">Logout</button>
      </div>
    </div>

    <div id="map"></div>

    <script>
      // Try to fetch the Maps key from the backend config endpoint.
      (async function(){
        try {
          const r = await fetch('/admin/config');
          if (r.ok) {
            const j = await r.json();
            window.__TG_MAP_KEY = j.data?.mapsKey || null;
          } else {
            window.__TG_MAP_KEY = null;
          }
        } catch (e) {
          // Fallback to URL hash if backend unavailable
          const hash = location.hash || '';
          const m = hash.match(/key=([^&]+)/);
          window.__TG_MAP_KEY = m ? decodeURIComponent(m[1]) : null;
        }
      })();
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let map;
      let markers = {};
      let token = null;

      const statusEl = document.getElementById('status');
      const btnLogin = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');

      function setStatus(txt) { statusEl.textContent = txt ? ' ‚Äî ' + txt : ''; }

      async function loadMapScript(key) {
        return new Promise((resolve, reject) => {
          if (window.google && window.google.maps) return resolve();
          const k = key || window.__TG_MAP_KEY || '';
          if (!k) return reject(new Error('No Maps API key provided. Add ?#key=YOUR_KEY to URL.'));
          const s = document.createElement('script');
          s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(k)}&libraries=places`;
          s.onload = () => resolve();
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 20.0, lng: 0.0 },
          zoom: 2,
        });
      }

      function updateMarker(userId, payload) {
        const pos = { lat: payload.location.lat, lng: payload.location.lng };
        if (markers[userId]) {
          markers[userId].setPosition(pos);
        } else {
          const marker = new google.maps.Marker({ position: pos, map, title: payload.name || payload.userId });
          const info = new google.maps.InfoWindow({ content: `<strong>${payload.name || 'User'}</strong><br>${payload.email||''}<br>${payload.phone||''}` });
          marker.addListener('click', () => info.open(map, marker));
          markers[userId] = marker;
        }
      }

      async function fetchLiveLocations() {
        try {
          const res = await fetch('/api/admin/live-locations', { headers: { Authorization: 'Bearer ' + token } });
          if (!res.ok) throw new Error('Failed to fetch locations: ' + res.status);
          const json = await res.json();
          const locations = json.data?.locations || [];
          locations.forEach(loc => updateMarker(loc.userId, { location: loc.location, name: loc.name, email: loc.email, phone: loc.phone }));
          if (locations.length) {
            map.setCenter({ lat: locations[0].location.lat, lng: locations[0].location.lng });
            map.setZoom(10);
          }
        } catch (e) {
          console.error(e);
          setStatus('Failed to load locations');
        }
      }

      function connectSocket() {
        const socket = io();
        socket.on('connect', () => {
          console.log('socket connected');
          socket.emit('join-admin');
          setStatus('Connected (socket)');
        });
        socket.on('live-location', (data) => {
          console.log('live-location', data);
          const userId = data.userId;
          updateMarker(userId, { location: data.location, name: data.name, email: data.email, phone: data.phone });
        });
        socket.on('new-alert', (data) => {
          console.log('new-alert', data);
        });
        socket.on('disconnect', () => setStatus('Disconnected'));
      }

      btnLogin.addEventListener('click', async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        if (!email || !password) return alert('Enter email & password');
        try {
          const res = await fetch('/api/user/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
          const j = await res.json();
          if (!res.ok) return alert(j.message || 'Login failed');
          token = j.data.token;
          localStorage.setItem('tg_admin_token', token);
          btnLogin.style.display = 'none'; btnLogout.style.display = 'inline-block';
          setStatus('Authenticated');
          try {
            await loadMapScript(window.__TG_MAP_KEY);
            initMap();
            await fetchLiveLocations();
            connectSocket();
          } catch (e) { alert('Map load failed: ' + e.message); }
        } catch (e) { alert('Login error: ' + e.message); }
      });

      btnLogout.addEventListener('click', () => {
        token = null; localStorage.removeItem('tg_admin_token');
        btnLogin.style.display = 'inline-block'; btnLogout.style.display = 'none';
        setStatus('Logged out');
      });

      // Auto-login if token stored
      (async function auto() {
        const stored = localStorage.getItem('tg_admin_token');
        if (stored) {
          token = stored;
          btnLogin.style.display = 'none'; btnLogout.style.display = 'inline-block';
          setStatus('Authenticated (stored token)');
          try {
            await loadMapScript(window.__TG_MAP_KEY);
            initMap();
            await fetchLiveLocations();
            connectSocket();
          } catch (e) { console.warn('Map/init failed', e); }
        }
      })();
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TourGuard - Community Safety Platform</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo-container">
                <div class="shield-logo">üõ°Ô∏è</div>
                <span class="platform-name">COMMUNITY SAFETY PLATFORM</span>
            </div>
            <div class="emergency-banner">EMERGENCY SOS</div>
        </div>
        <div class="header-right">
            <button class="menu-btn" id="menuBtn">‚ò∞</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Column -->
        <div class="left-column">
            <!-- Live Incident Map -->
            <div class="panel map-panel">
                <h2>LIVE INCIDENT MAP</h2>
                <div id="map" class="map-container"></div>
            </div>

            <!-- User Information -->
            <div class="panel user-panel">
                <h2>USER INFORMATION</h2>
                <div id="userInfo" class="user-info">
                    <div class="user-placeholder">
                        <p>No active incident. Waiting for alerts...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="right-column">
            <!-- Nearby Help & Resources -->
            <div class="panel resources-panel">
                <h2>NEARBY HELP & RESOURCES</h2>
                <div id="resourcesList" class="resources-list">
                    <div class="resource-item">
                        <span class="resource-icon">üö®</span>
                        <div class="resource-info">
                            <span class="resource-name">Loading resources...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Communication Log -->
            <div class="panel log-panel">
                <h2>COMMUNICATION LOG</h2>
                <div id="communicationLog" class="log-container">
                    <div class="log-entry">[System] Admin panel connected. Waiting for events...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Action Bar -->
    <div class="action-bar">
        <button class="action-btn broadcast-btn" id="broadcastBtn">BROADCAST ALERT</button>
        <button class="action-btn manual-btn" id="manualDispatchBtn">MANUAL DISPATCH</button>
        <button class="action-btn resolve-btn" id="resolveBtn">RESOLVE INCIDENT</button>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Admin Login</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="login-submit-btn">Login</button>
            </form>
            <div id="loginError" class="error-message"></div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>

